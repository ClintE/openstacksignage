<!DOCTYPE html>

<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>OpenStack Signage</title>

    <link href="https://fonts.googleapis.com/css?family=Lato:100" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-bootgrid/1.3.1/jquery.bootgrid.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-bootgrid/1.3.1/jquery.bootgrid.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.6/moment-timezone-with-data.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="https://vitalets.github.io/x-editable/assets/x-editable/bootstrap3-editable/css/bootstrap-editable.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.18.1/URI.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/styles/metro/notify-metro.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-serialize-object/2.5.0/jquery.serialize-object.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>

    <style>
        .container {
            padding:0;
            padding-left:20px;
            margin:0;
        }
        body {
            padding:0;
        }
        .navbar-fixed-top, .navbar-fixed-bottom, .navbar-static-top {
            margin-left: 0;
            margin-right: 0;
            margin-bottom:0;
        }
        .searchBox {
            width: 200px;
            display: inline-block;
            margin: 0px 10px;
        }
        table#filters td {
            padding: 0 10px;
            padding-bottom: 5px;
        }
        table#filters td button {
            margin-right: 5px;
            min-width: 80px;
        }
        input[type="search"] {
            -webkit-appearance: searchfield;
        }
        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: searchfield-cancel-button;
        }
        thead {
            font-size: 12px;
        }
        tbody {
            font-size: 12px;
        }
        .eventColumn {
            width: 8%;
        }
        .titleColumn {
            width: 25%;
        }
        .speakersColumn {
            width: 15%;
        }
        .floorRoomColumn {
            width: 15%;
        }
        .screenLinkColumn {
            width: 15%;
        }
        .tagsColumn {
            width: 15%;
        }
        .dateColumn {
            width: 8%;
        }
        .wheel{
            width:30px;
        }
        .wheel-loading {
            animation: ani 2s infinite linear;
        }
        @keyframes ani {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(359deg);
            }
        }
        .btn-space {
            margin-right: 5px;
        }
    </style>
</head>

<body>
<div>
    <a class="connect" style="margin: 20px;
    border: 1px solid silver;
    border-radius: 10px;
    padding: 10px;cursor: pointer">Connect</a>
    <span class="token">Please authenticate by clicking on the Connect button above.</span>
</div>

<div id="firebase-dialog" title="Firebase Authentication" style="display: none;">
    <form>
    <div class="form-group">
        <label for="username">Email:</label>
        <input type="email" name="username" class="form-control" />
    </div>
    <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" name="password" class="form-control" />
    </div>
    <input type="submit" name="" style="position:absolute; top:-1000px;">
    </form>
</div>

<div id="banner-dialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="message dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="message dialog title">New Message</h4>
            </div>
            <form>
                <div class="modal-body">
                    <input type="hidden" name="id" value="0">
                    <input type="hidden" name="class_name" value="ScheduledSummitLocationBanner">
                    <div class="form-group">
                        <input type="text" class="form-control" name="title" aria-describedby="message title" placeholder="This is the message title. Required. (May be used on sign or only for reference)" required/>
                    </div>
                    <div class="form-group">
                        <textarea class="form-control" name="content" aria-describedby="message content" placeholder="This is the content of the message. Required." required></textarea>
                    </div>
                    <div class="form-group row">
                        <label for="banner-start" class="col-md-1 col-form-label">Start</label>
                        <div class="col-md-5">
                            <div class='input-group date' id="banner-start" aria-describedby="message start date">
                                <input type='text' class="form-control" name="start_date" required/>
                                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                            </div>
                        </div>
                        <label for="banner-type" class="col-md-1 col-form-label">Type</label>
                        <div class="col-md-5">
                            <select class="form-control" id="banner-type" name="type" aria-describedby="message type">
                                <option selected value="Primary">Top message</option>
                                <option value="Secondary">Footer message</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="banner-end" class="col-md-1 col-form-label">End</label>
                        <div class="col-md-5">
                            <div class='input-group date' id="banner-end" aria-describedby="message end date">
                                <input type='text' class="form-control" name="end_date" required/>
                                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                            </div>
                        </div>
                        <!--
                        <label for="banner-active" class="col-md-1 col-form-label">Active</label>
                        <div class="col-md-5">
                            <input type="checkbox" class="form-check-input" id="banner-active" name="active" aria-describedby="message active">
                        </div> -->
                        <input type="hidden" name="enabled" value="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" aria-describedby="message submit">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="authenticated" style="margin-top: 20px; padding-top: 20px; padding-bottom: 20px; background-color: #EDF2F7">
    <div class="container">
        <div class='row'>
            <div class='col-md-3'>
                <div class="form-group row">
                    <label for="summits" class="col-md-3 col-form-label">Summit</label>
                    <div class="col-md-9">
                        <select id="summits" class="selectpicker form-control" title="Not authenticated" disabled></select>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="locations" class="col-md-3 col-form-label">Location</label>
                    <div class="col-md-9">
                        <select id="locations" class="selectpicker form-control" title="Not authenticated" data-live-search="true" disabled></select>
                    </div>
                </div>
            </div>
            <div class='col-md-3'>
                <div class="form-group row">
                    <label for="input-date" class="col-md-3 col-form-label">Date</label>
                    <div class="col-md-9">
                        <input type="date" id="input-date" class="form-control" disabled />
                    </div>
                </div>
                <div class="form-group row">
                    <label for="input-time" class="col-md-3 col-form-label">Time</label>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="time" id="input-time" class="form-control" disabled />
                            </div>
                            <div class="col-md-6">
                                <button id="btn-jump" type="button" class="btn btn-block btn-primary" disabled>Jump</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <form id="static-banner">
                    <input type="hidden" name="id" value="0">
                    <input type="hidden" name="class_name" value="SummitLocationBanner">
                    <input type="hidden" name="title" value="Static Banner"/>
                    <input type="hidden" name="type" value="Primary">
                    <input type="hidden" name="enabled" value="1">
                    <div class="col-md-8">
                        <textarea class="form-control" name="content" rows="3" aria-describedby="static message content" placeholder="This is the static banner content. Empty save to delete." disabled></textarea>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary" aria-describedby="message submit" data-loading-text="<i class='fa fa-circle-o-notch fa-spin'></i> Saving" disabled>Save</button>
                    </div>
                </form>
            </div>
            <div class="col-md-2">
                <button id="btn-reset" type="button" class="btn btn-default" disabled>Reset Sign</button>
                <!--<button id="btn-view" type="button" class="btn btn-default" disabled>View Sign</button>-->
            </div>
        </div>
        <div class="row">
            <div class='col-md-3'>
                <div class="form-group row">
                    <label for="view" class="col-md-3 col-form-label">View</label>
                    <div class="col-md-9">
                        <select id="view" class="selectpicker form-control" disabled>
                            <option value="events" selected>Events</option>
                            <option value="banners">Messages</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div style="padding: 10px;">
    <div id="events" style="display: none;">
        <table id="grid-data-events" data-ajax="true" class="table table-condensed table-hover table-striped">
            <thead>
            <tr>
                <th data-column-id="id" data-type="numeric" data-converter="numeric" data-identifier="true" data-header-css-class="eventColumn">EventID</th>
                <th data-column-id="title" searchable="true" data-formatter="eventtitle" data-header-css-class="titleColumn">Event Title</th>
                <th data-column-id="speakers" data-formatter="csvspeakers" data-sortable="false" data-header-css-class="speakersColumn">Speakers</th>
                <th data-column-id="floorroom" data-formatter="floorroom" data-header-css-class="floorRoomColumn" data-sortable="false">Floor / Location</th>
                <th data-column-id="tags" data-formatter="csvtags" data-sortable="false" data-header-css-class="tagsColumn">Tags</th>
                <th data-column-id="start_date" data-formatter="date" data-sortable="true" data-header-css-class="dateColumn">Start date</th>
                <th data-column-id="end_date" data-formatter="date" data-sortable="true" data-header-css-class="dateColumn">End date</th>
                <th data-column-id="event_actions" data-formatter="event_actions" data-header-css-class="screenLinkColumn" data-sortable="false">Actions</th>
            </tr>
            </thead>
        </table>
    </div>
    <div id="banners" style="display: none;">
        <table id="grid-data-banners" data-ajax="true" class="table table-condensed table-hover table-striped">
            <thead>
            <tr>
                <th data-column-id="id" data-type="numeric" data-converter="numeric" data-identifier="true" data-header-css-class="messageColumn">ID</th>
                <th data-column-id="title" searchable="true" data-formatter="bannertitle" data-header-css-class="speakersColumn">Message Title</th>
                <th data-column-id="content" searchable="true" data-formatter="bannercontent" data-header-css-class="titleColumn">Message Content</th>
                <th data-column-id="banner_type" data-formatter="bannertype" data-sortable="true" data-header-css-class="dateColumn">Type</th>
                <th data-column-id="floorroom" data-formatter="floorroom" data-header-css-class="floorRoomColumn" data-sortable="false">Floor / Location</th>
                <th data-column-id="start_date" data-formatter="date" data-sortable="true" data-header-css-class="dateColumn">Start date</th>
                <th data-column-id="end_date" data-formatter="date" data-sortable="true" data-header-css-class="dateColumn">End date</th>
                <th data-column-id="banner_actions" data-formatter="banner_actions" data-header-css-class="screenLinkColumn" data-sortable="false">Actions</th>
            </tr>
            </thead>
        </table>
        <button class="btn btn-default" type="button" data-toggle="modal" data-target="#banner-dialog" data-action="create">New Message</button>
    </div>
</div>

    <script type="text/javascript" charset="utf-8">
        
        $( document ).ready(function() {

            $('#input-date').val(moment().format('Y-M-D'));
            $('#input-time').val(moment().format('HH:mm'));

            const db = firebase.initializeApp({
                apiKey: 'AIzaSyBPUYAZxU9DqLyUfZrSKpmIsmauZIeo0S8',
                authDomain: 'open-signage-staging.firebaseapp.com',
                projectId: 'open-signage-staging',
                databaseURL: 'https://open-signage-staging.firebaseio.com/',
            }).database()

            $('#btn-view').on('click', function(e) {
                window.open('/#?location=' + $('#locations').val())
            });

            $('#btn-reset').on('click', function(e) {
                firebaseUpdate('reload', $('#locations').val())
            });

            $('#btn-jump').on('click', function(e) {

                var date = moment.tz([
                    $('#input-date').val(),
                    $('#input-time').val()
                ].join(' '), 'Y-M-D HH:mm', timeZone);

                if ( ! date.isValid()) {
                    return alert('Invalid date')
                }

                firebaseUpdate('time', $("#locations").val() + '&' + date.unix());
            });

            var firebaseUpdate = function(field, value) {
                // We need the value to *change* so clear it first.
                firebaseLogin().then(function() {
                    return db.ref(field).set('').then(function() {
                        return db.ref(field).set(value)
                    })
                }).catch(function(err) {
                    console.error(err)
                })
            };

            var firebaseLogin = function() {
                return new Promise(function(resolve, reject) {
                    if (firebase.auth().currentUser) {
                        return resolve(firebase.auth().currentUser)
                    }

                    $('#firebase-dialog input[name=username]').val('')
                    $('#firebase-dialog input[name=password]').val('')

                    var dialog = $('#firebase-dialog').dialog({
                        modal: true,
                        width: 300,
                        resizable: false,
                        buttons: [{
                        text: 'Login',
                        click: function() {
                                $('#firebase-dialog form').submit()
                            }
                        },{
                            text: 'Cancel',
                            click: function() {
                                $(this).dialog('close')
                            }
                        }]
                    })

                    $('#firebase-dialog form').off('submit').on('submit', function(e) {
                        e.preventDefault()

                        firebase.auth().signInWithEmailAndPassword(
                            $('#firebase-dialog input[name=username]').val(),
                            $('#firebase-dialog input[name=password]').val()
                        ).then(function() {
                            dialog.dialog('close')
                        }).catch(function(err) {
                            alert('Firebase: ' + err.message)
                            $('#firebase-dialog input[name=username]').focus()
                        })
                    })

                    dialog.off('dialogclose').on('dialogclose', function(e) {
                        if (firebase.auth().currentUser) {
                            return resolve()
                        }
                        reject()
                    })
                })
            }

            var conventionCenter = null;

            var timeZone = "UTC";
            var timePickerDateFormat = 'MM/DD/YYYY h:mm A';
            
            var spanWithTooltips = function(text){
                return "<span title='"+ text + "'>"+text+"</span>";
            };
            
            var extractToken = function() {
                var uri = new URI();
                return URI.parseQuery(uri.fragment()).access_token;
            };

            var extractSummitID = function(){
                return $("#summit_id").val();
                /*
                var uri = new URI();
                return URI.parseQuery(uri.query()).summit_id;
                */
            };

            var extractLocationID = function(){
                return $("#location_id").val();
                /*
                var uri = new URI();
                return URI.parseQuery(uri.query()).location_id;
                */
            };
            
            var fillSummitList =  function(){
                $.ajax({
                    url: summits_resource,
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader ("Authorization", "Bearer " + unescape(token));
                        xhr.setRequestHeader('Accept', "application/json");
                        xhr.setRequestHeader('Content-Type', 'application/json"');
                    }, 
                    success: function (response, textStatus, jqXHR ) {

                        var data = response.data.reverse();

                        $("#summits").empty();
                        $("#summits").prop("disabled", false);

                        $.each(data, function(index, value) {

                            $('<option/>', {
                                text: value.name,
                                value: value.id,
                                data: {
                                    time_zone: value.time_zone.name,
                                    start_date: value.start_date,
                                    end_date: value.end_date
                                }
                            }).appendTo($("#summits"));

                        });

                        $("#summits > option:first-child").attr("selected", "selected");
                        $("#summits").selectpicker('refresh');
                        $("#summits").change();
                    },
                    error:function (jqXHR, textStatus, errorThrown ){
                        console.log(errorThrown);
                    }                       
                });
            };
            
            var fillLocationList =  function(summit_id){
                $.ajax({
                    url: locations_resource.replace("{summit_id}", summit_id),
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader ("Authorization", "Bearer " + unescape(token));
                        xhr.setRequestHeader('Accept', "application/json");
                        xhr.setRequestHeader('Content-Type', 'application/json');
                    }, 
                    success: function (response, textStatus, jqXHR ) {

                        $("#locations").empty();
                        $("#locations").prop("disabled", false);

                        var data = response.data;
                        conventionCenter = data[0];

                        $.each(data, function(index, value) {

                            if (value.class_name == 'SummitVenue') {

                                let venue = $("<option></option>")
                                    .attr("value", 0)
                                    .text("All " + value.name + " Locations")
                                    .data("content", "All <span style='font-style: italic;'>" + value.name + "</span> Locations");

                                $("#locations").append(venue);

                                let sortedFloors = value.floors.sort(function(x, y) { return x.number > y.number });

                                $.each(sortedFloors, function(floor_idx, floor_value) {

                                    let floor = $("<optgroup></optgroup>")
                                        .attr("label", floor_value.name);

                                    let floorRooms =
                                        $.grep(value.rooms, function(n, i) {
                                            return n.floor_id == floor_value.id;
                                        });

                                    $.each(floorRooms, function(room_idx, room_value) {

                                        let room = $("<option></option>")
                                            .attr("value", room_value.id)
                                            .text(room_value.name)
                                            .attr("data-tokens", [floor_value.number, floor_value.name].join(' '));

                                        floor.append(room);
                                    });

                                    floor.html(floor.children("option").sort(function (x, y) {
                                        return $(x).text().toUpperCase() < $(y).text().toUpperCase() ? -1 : 1;
                                    }));

                                    $("#locations").append(floor);
                                });
                            }
                        });

                        $("#locations")
                            .selectpicker({"title": "Please select a location"})
                            .selectpicker('refresh');

                    },
                    error:function (jqXHR, textStatus, errorThrown ){
                        console.log(errorThrown);
                    }                       
                });
            };

            var getStaticBanner = function() {

                var url = banners_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val());

                $.ajax({
                    url: url,
                    type: "GET",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", "Bearer " + unescape(token));
                        xhr.setRequestHeader('Accept', "application/json");
                        xhr.setRequestHeader('Content-Type', 'application/json');
                    },
                    data: {
                        "filter": "class_name==SummitLocationBanner",
                    },
                })
                    .done(function(data, textStatus, jqXHR) {
                        console.log("HTTP Request Succeeded: " + jqXHR.status);
                        console.log(data);

                        if (data.data.length) {

                            let message = data.data[0];

                            $('#static-banner input[name=id]').val(message.id);
                            $('#static-banner textarea[name=content]').val(message.content);

                        }

                        $('#static-banner textarea[name=content]').prop("disabled", false);
                        $('#static-banner button').prop("disabled", false);
                    })
                    .fail(function(jqXHR, textStatus, errorThrown) {
                        console.log("HTTP Request Failed");
                    })
                    .always(function() {
                        /* ... */
                    });
            };

            var createOrUpdateBanner = function(payload) {

                let posfix = payload.id != 0 ? "/" + payload.id : "";
                let method = payload.id != 0 ? "PUT" : "POST";

                delete payload["id"];

                    $.ajax({
                    url: banners_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val()) + posfix,
                    type: method,
                    contentType: "application/json; charset=utf-8",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", "Bearer " + unescape(token));
                        xhr.setRequestHeader('Accept', "application/json");
                        xhr.setRequestHeader('Content-Type', 'application/json');
                    },
                    dataType: "json",
                    data: JSON.stringify(payload),
                })
                    .done(function(data, textStatus, jqXHR) {

                        console.log("HTTP Request Succeeded: " + jqXHR.status);
                        console.log(data);
                    })
                    .fail(function(jqXHR, textStatus, errorThrown) {

                        console.log("HTTP Request Failed");
                        alert(jqXHR.responseText);
                    })
                    .always(function() {

                        if (payload.class_name == "ScheduledSummitLocationBanner") {

                            $("#view").change();

                        } else {

                            getStaticBanner();
                        }
                    });
            };

            var deleteBanner = function(id) {

                $.ajax({
                    url: banners_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val()) + '/' + id,
                    type: "DELETE",
                    contentType: "application/json; charset=utf-8",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", "Bearer " + unescape(token));
                        xhr.setRequestHeader('Accept', "application/json");
                        xhr.setRequestHeader('Content-Type', 'application/json');
                    }
                })
                    .done(function(data, textStatus, jqXHR) {

                        console.log("HTTP Request Succeeded: " + jqXHR.status);
                        console.log(data);
                    })
                    .fail(function(jqXHR, textStatus, errorThrown) {

                        console.log("HTTP Request Failed");
                        alert(jqXHR.responseText);
                    })
                    .always(function() {

                        if ($('#static-banner button').prop("disabled") == true) {

                            $('#static-banner textarea[name=content]').prop("disabled", false);
                            $('#static-banner button').prop("disabled", false);

                        } else {

                            $("#view").change();
                        }

                    });
            };

            const environment = window.location.hostname == "local.openstack.org" ? "" : "staging";

            switch (environment) {
                case "staging":
                    var idp_host = "testopenstackid.openstack.org";
                    var resource_server_host = "testresource-server.openstack.org";
                    var client_id = "JoRAdC4FA1LZa_mauMXSSVK~BrI8m4MZ.openstack.client";
                    // client configured for https://signage.openstack.org/
                    break;
                case "production":
                    var idp_host = "openstackid.org";
                    var resource_server_host = "openstackid-resources.openstack.org";
                    var client_id = "DnbJDeuhguoLkw6wVz.WWp53hxcgvVfP.openstack.client";
                    // client configured for https://signage.openstack.org/
                    break;
                default:
                    var idp_host = "testopenstackid.openstack.org";
                    var resource_server_host = "testresource-server.openstack.org";
                    var client_id = "TZ8jZKfHegAmbFn8G7jRp2FkdlpiIkiz.openstack.client";
                    // client configured for https://local.openstack.org/
            }

            var setting =
                {
                    'host': idp_host,
                    'rserver_host': resource_server_host,
                    'clientId': client_id,
                    'scopes':   'https://' + resource_server_host + '/summits/read ' +
                                'https://' + resource_server_host + '/locations/banners/write'
                };

            //these values might be taken from query string, however auth2 redirection is not returning second parameter
            var summit_id = extractSummitID();
            var location_id = extractLocationID();

            var authHost     = "https://" + setting.host;
            var summits_resource = "https://" + setting.rserver_host + "/api/v1/summits";
            var locations_resource = "https://" + setting.rserver_host + "/api/v1/summits/{summit_id}/locations";
            var summit_events_resource = "https://" + setting.rserver_host + '/api/v1/summits/{summit_id}/events/published';
            var events_resource = "https://" + setting.rserver_host + '/api/v1/summits/{summit_id}/locations/{location_id}/events/published';
            var banners_resource = "https://" + setting.rserver_host + '/api/v1/summits/{summit_id}/locations/{location_id}/banners';
            var endUserAuthorizationEndpoint = authHost + "/oauth2/auth";
            

            var token = extractToken();
            var authUrl = endUserAuthorizationEndpoint +
                        "?response_type=token id_token" +
                        "&approval_prompt=force"+
                        "&scope=" + encodeURI(setting.scopes)+
                        "&client_id="  + encodeURI(setting.clientId) +
                        "&redirect_uri=" + window.location;

            $("a.connect").attr("href", authUrl);
            
            $("#summits").on('change', function() {

                $("#events, #banners").hide();

                $("#input-date").prop("disabled", true);
                $("#input-time").prop("disabled", true);

                $("#btn-jump").prop("disabled", true);
                $("#btn-reset").prop("disabled", true);

                $("#view").prop("disabled", true);
                $("#view > option:first-child").attr("selected", "selected");
                $("#view").selectpicker('refresh');

                initializeBannerModal();

                fillLocationList(this.value);
            });
            
            $("#locations").on('change', function() {

                $("#input-date").prop("disabled", false);
                $("#input-time").prop("disabled", false);

                $("#btn-jump").prop("disabled", false);
                $("#btn-reset").prop("disabled", false);

                $('#static-banner input[name=id]').val(0);
                $('#static-banner textarea[name=content]').val("");
                $('#static-banner textarea[name=content]').prop("disabled", true);
                $('#static-banner button').prop("disabled", true);

                getStaticBanner();

                $("#view").prop("disabled", false);
                $("#view").selectpicker('refresh');
                $("#view").change();
            });

            $("#view").on('change', function() {

                let grid = $("#view").val();

                if (grid === "events") {

                    $("#banners").hide();
                    $("#events").show();

                    $("#grid-data-events").bootgrid("destroy");

                    $("#view").prop(
                        "disabled", isNaN(parseInt($('#locations').val()))
                    );

                    if ($('#locations').val() === '0') {
                        return initializeEventsGrid(summit_events_resource.replace(
                            '{summit_id}', $("#summits").val()
                        ))
                    }

                    var new_url = events_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val());

                    initializeEventsGrid(new_url);

                } else if (grid === "banners") {

                    $("#events").hide();
                    $("#banners").show();

                    $("#grid-data-banners").bootgrid("destroy");

                    if ($('#locations').val() === '0') {

                        return;
                    }

                    var new_url = banners_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val());

                    initializeBannersGrid(new_url);
                }
            });
            
            if (token) {
                $('span.token').text("You are authenticated");
                $("a.connect").text('Re-connect');
                fillSummitList();
            }

            function initializeBannerModal() {

                // Configure global time zone
                // and banner dialog date pickers

                let summitSelected = $("#summits > option:selected");

                timeZone = summitSelected.data("time_zone");

                let startDate = summitSelected.data("start_date");
                let endDate = summitSelected.data("end_date");

                var options = {
                    minDate: moment.unix(startDate).tz(timeZone),
                    maxDate: moment.unix(endDate).tz(timeZone),
                    defaultDate: false,
                };

                let startTimePicker = $('#banner-start');
                let startTimePickerData = startTimePicker.data("DateTimePicker");

                if (startTimePickerData) {

                    startTimePickerData.minDate(false);
                    startTimePickerData.maxDate(false);

                    startTimePickerData.minDate(options.minDate);
                    startTimePickerData.maxDate(options.maxDate);

                } else {

                    startTimePicker.datetimepicker(options);
                }

                let endTimePicker = $('#banner-end');
                let endTimePickerData = endTimePicker.data("DateTimePicker");

                if (endTimePickerData) {

                    endTimePickerData.minDate(false);
                    endTimePickerData.maxDate(false);

                    endTimePickerData.minDate(options.minDate);
                    endTimePickerData.maxDate(options.maxDate);

                } else {

                    endTimePicker.datetimepicker(options);
                }
            }

            function cleanBannerModal() {

                let defaultStartDate = $('#banner-start').data("DateTimePicker").minDate();
                let defaultEndDate = $('#banner-end').data("DateTimePicker").maxDate();

                let modal = $("#banner-dialog");

                modal.find('.modal-body input[name=id]').val(0);
                modal.find('.modal-body input[name=title]').val("");
                modal.find('.modal-body textarea[name=content]').val("");
                modal.find('.modal-body input[name=start_date]').val(defaultStartDate.format(timePickerDateFormat));
                modal.find('.modal-body input[name=end_date]').val(defaultEndDate.format(timePickerDateFormat));
                modal.find('.modal-body select[name=type]').val(defaultEndDate.format(timePickerDateFormat));
                modal.find('.modal-body select > option:first-child').prop("selected", true);
            }

            function initializeEventsGrid(url){
                $("#grid-data-events").bootgrid({
                    ajax: true,
                    ajaxSettings: {
                        method: "GET",
                        cache: false,
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader ("Authorization", "Bearer " + unescape(token));
                            xhr.setRequestHeader('Accept', "application/json");
                            xhr.setRequestHeader('Content-Type', 'text/plain');
                        }
                    },
                    url: url,
                    requestHandler:function (request) {
                            var title = $('#event_title').val().length ? 'title=@' + $('#event_title').val().trim() : '';
                            var keyword = $('#event_keyword').val().length ? 'tags=@' + $('#event_keyword').val().trim() : '';
                            var filters =  (title.length && keyword.length ? [ title , keyword ] : keyword+ '' + title);
                            var isSorted = (request.sort);
                            var orderBy = '';
                            if(isSorted){
                                var order = Object.keys(request.sort)[0] || 'start_date';
                                var asc = request.sort[Object.keys(request.sort)[0]] || 'asc';
                                orderBy = (asc === 'asc' ?  '+' : '-') + order  ;

                                var request = {
                                    filter : filters,
                                    page: request.current,
                                    per_page: request.rowCount,
                                    order: orderBy,
                                    expand:"speakers,location",
                                };
                            }else{
                                var request = {
                                    filter: filters,
                                    page: request.current,
                                    per_page: request.rowCount
                                };
                            }
                            return request;
                        },
                    responseHandler:function (response) {
                        var response = {
                            current: response.current_page,
                            rowCount: response.per_page,
                            rows: response.data,
                            total: response.total
                        };

                        return response;

                    },
                     formatters: {
                        eventtitle: function (column, row){
                            return spanWithTooltips(row[column.id]);
                        },
                        csvspeakers: function (column, row){
                            if(row[column.id]){
                                var arr = jQuery.map( $(row[column.id]), function( speaker ) {
                                   return speaker.first_name + ' ' + speaker.last_name;
                                });
                                return spanWithTooltips(arr.join(", "));
                            }else{
                                return "";
                            }
                        },
                        csvtags: function (column, row){
                            if(row[column.id]){
                                var arr = jQuery.map( $(row['tags']), function( tag ) {
                                   return tag.tag;
                                });
                                return spanWithTooltips(arr.join(","));
                            }else{
                                return "";
                            }
                        },
                        floorroom: function(column, row) {
                            var floor = 'N/A'
                            var room = 'N/A'

                            if (row.location) {
                                room = row.location.name

                                var f = (conventionCenter.floors || []).filter(function(f) {
                                    return f.id === row.location.floor_id
                                }).shift()

                                if (f) { floor = f.name }
                            }

                            var title = floor + ' / ' + room
                            return '<span title="' + title + '">' + title + '</span>';
                        },
                        event_actions: function (column, row) {

                            return '<button class="btn btn-primary btn-sm event-jump" data-ts="' + row.start_date + '">Jump</button>';
                        },
                        date: function(column, row){
                            var utc_date = row[column.id];
                            var date = moment.unix(utc_date);
                            return date.tz(timeZone).format('MM/DD HH:mm');
                        }
                    },
                    rowCount: [10, 25, 50, 100],
                    templates: {
                        header: "<div id=\"{{ctx.id}}\" class=\"{{css.header}}\"><div class=\"row\"><div class=\"col-md-12 actionBar\"><div class=\"wheel\"/><input type='search' class='search-field form-control searchBox' placeholder='Title' id='event_title'><input type='search' class='search-field form-control searchBox' id='event_keyword' placeholder='Tag keyword'><p class=\"{{css.actions}}\"></p></div></div></div>"
                    },
                    selection: false,
                    multiSelect: false,

                }).on("selected.rs.jquery.bootgrid", function (e, rows) {
                    console.log(rows);
                    console.log("selected");
                }).on("deselected.rs.jquery.bootgrid", function (e, rows) {
                    console.log("deselected");
                }).on("click.rs.jquery.bootgrid", function (e,columns,rows) {
                    console.log("click");
                }).on("loaded.rs.jquery.bootgrid", function (e){

                    $('.event-jump').on('click', e => {

                        firebaseUpdate('time',

                            $("#locations").val() + '&' + $(e.currentTarget).data('ts')
                        )
                    });

                    console.log("loaded");
                });
            }

            function initializeBannersGrid(url){

                $("#grid-data-banners").bootgrid({
                    ajax: true,
                    ajaxSettings: {
                        method: "GET",
                        cache: false,
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader ("Authorization", "Bearer " + unescape(token));
                            xhr.setRequestHeader('Accept', "application/json");
                            xhr.setRequestHeader('Content-Type', 'text/plain');
                        }
                    },
                    url: url,
                    requestHandler:function (request) {
                        var title = $('#banner_title').val().length ? 'title=@' + $('#banner_title').val().trim() : '';
                        var keyword = $('#banner_content').val().length ? 'content=@' + $('#banner_content').val().trim() : '';
                        var class_name = 'class_name==ScheduledSummitLocationBanner';
                        var filters =  (title.length && keyword.length && class_name.length ? [ title , keyword, class_name ] : keyword+ '' + title+ '' + class_name);
                        var isSorted = (request.sort);
                        var orderBy = '';
                        if(isSorted){
                            var order = Object.keys(request.sort)[0] || 'start_date';
                            var asc = request.sort[Object.keys(request.sort)[0]] || 'asc';
                            orderBy = (asc === 'asc' ?  '+' : '-') + order  ;

                            var request = {
                                filter : filters,
                                page: request.current,
                                per_page: request.rowCount,
                                order: orderBy,
                                expand:"location",
                            };
                        }else{
                            var request = {
                                filter: filters,
                                page: request.current,
                                per_page: request.rowCount
                            };
                        }
                        return request;
                    },
                    responseHandler:function (response) {
                        var response = {
                            current: response.current_page,
                            rowCount: response.per_page,
                            rows: response.data,
                            total: response.total
                        };

                        return response;

                    },
                    formatters: {
                        bannertitle: function (column, row){
                            return spanWithTooltips(row[column.id]);
                        },
                        floorroom: function(column, row) {
                            var floor = 'N/A'
                            var room = 'N/A'

                            if (row.location) {
                                room = row.location.name

                                var f = (conventionCenter.floors || []).filter(function(f) {
                                    return f.id === row.location.floor_id
                                }).shift()

                                if (f) { floor = f.name }
                            }

                            var title = floor + ' / ' + room
                            return '<span title="' + title + '">' + title + '</span>';
                        },
                        bannertype: function (column, row) {

                            return (row.type == "Primary") ? "Top message" : "Footer message";
                        },
                        banner_actions: function (column, row) {

                            var encoded = btoa(JSON.stringify(row));

                            var actions = "<button class=\"btn btn-primary btn-sm btn-space event-jump\" data-ts=\"' + row.start_date + '\">Jump</button>";

                            actions +=
                                "<button type=\"button\" class=\"btn btn-default btn-sm btn-space banner-action\" data-action=\"edit\" data-base64=\"" + encoded + "\" data-target=\"#banner-dialog\" aria-label=\"Edit\">\n" +
                                "  <span class=\"glyphicon glyphicon-pencil\" aria-hidden=\"true\"></span>\n" +
                                "</button>";

                            actions +=
                                "<button type=\"button\" class=\"btn btn-default btn-sm banner-action\" data-action=\"delete\" data-identifier=\"" + row.id + "\" aria-label=\"Delete\">\n" +
                                "  <span class=\"glyphicon glyphicon-trash\" aria-hidden=\"true\"></span>\n" +
                                "</button>";

                            return actions;
                        },
                        date: function(column, row){
                            var utc_date = row[column.id];
                            var date = moment.unix(utc_date);
                            return date.tz(timeZone).format('MM/DD HH:mm');
                        }
                    },
                    rowCount: [10, 25, 50, 100],
                    templates: {
                        header: "<div id=\"{{ctx.id}}\" class=\"{{css.header}}\"><div class=\"row\"><div class=\"col-md-12 actionBar\"><div class=\"wheel\"/><input type='search' class='search-field form-control searchBox' placeholder='Title' id='banner_title'><input type='search' class='search-field form-control searchBox' id='banner_content' placeholder='Content'><p class=\"{{css.actions}}\"></p></div></div></div>"
                    },
                    selection: false,

                }).on("click.rs.jquery.bootgrid", function (e,columns,rows) {
                    console.log("click");
                }).on("loaded.rs.jquery.bootgrid", function (e){

                    $('.event-jump').on('click', e => {

                        firebaseUpdate('time',

                            $("#locations").val() + '&' + $(e.currentTarget).data('ts')
                        )
                    });

                    $('.banner-action').on('click', e => {

                        let target = $(e.currentTarget);

                        switch (target.data("action")) {

                            case "edit":

                                let encoded = target.data("base64");
                                let decoded = JSON.parse(atob(encoded));

                                if (decoded != null) {

                                    let startDate = moment.unix(decoded.start_date);
                                    let endDate = moment.unix(decoded.end_date);

                                    let modal = $(target.data("target"));

                                    modal.modal("show");
                                    modal.find('.modal-title').text("Edit Message");
                                    modal.find('.modal-body input[name=id]').val(decoded.id);
                                    modal.find('.modal-body input[name=title]').val(decoded.title);
                                    modal.find('.modal-body textarea[name=content]').val(decoded.content);
                                    modal.find('.modal-body input[name=start_date]').val(startDate.tz(timeZone).format(timePickerDateFormat));
                                    modal.find('.modal-body input[name=end_date]').val(endDate.tz(timeZone).format(timePickerDateFormat));
                                    modal.find('.modal-body select > option[value="' + decoded.type + '"]').prop("selected", true);
                                }

                                break;

                            case "delete":

                                target.addClass("disabled");
                                deleteBanner(target.data('identifier'));
                                break;

                            default:
                                break;
                        }
                    });
                });
            }

            $('#banner-dialog').on('show.bs.modal', function (event) {

                var button = $(event.relatedTarget);

                var action = button.data('action');

                if (action === "create") {

                    cleanBannerModal();

                    var modal = $(this);
                    modal.find('.modal-title').text("New Message");
                }
            });

            $('#banner-dialog form').on('submit', function(ev) {

                var payload = $(this).serializeObject();

                let start_date = moment.tz(payload.start_date, timePickerDateFormat, timeZone);
                let end_date = moment.tz(payload.end_date, timePickerDateFormat, timeZone);

                payload.start_date = start_date.unix();
                payload.end_date = end_date.unix();

                // Perform api call
                createOrUpdateBanner(payload);

                $('#banner-dialog').modal('hide');

                ev.preventDefault();
            });

            $("#static-banner").on('submit', function(ev) {

                var payload = $(this).serializeObject();

                $('#static-banner button').prop("disabled", true);
                $('#static-banner textarea[name=content]').prop("disabled", true);

                if (payload.id != 0 && payload.content == "") {

                    $('#static-banner input[name=id]').val(0);

                    deleteBanner(payload.id);

                } else {

                    createOrUpdateBanner(payload);
                }

                ev.preventDefault();
            });

            /*
            $(document).tooltip({
                show: null,
                position: {
                    my: "left top",
                    at: "left bottom"
                },
                open: function( event, ui ) {
                    ui.tooltip.animate({ top: ui.tooltip.position().top + 10 }, "fast" );
                }
            });
            */
            
            $(document).on({
                ajaxStart: function() { $(".glyphicon-refresh").addClass("wheel-loading"); },
                ajaxStop: function() { $(".glyphicon-refresh").removeClass("wheel-loading"); }
            });
        });
    </script>
</body>
</html>